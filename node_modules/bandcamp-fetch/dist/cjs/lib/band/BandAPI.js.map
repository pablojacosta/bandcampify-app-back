{"version":3,"file":"BandAPI.js","sourceRoot":"","sources":["../../../../src/lib/band/BandAPI.ts"],"names":[],"mappings":"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","sourcesContent":["import ImageAPI from '../image/ImageAPI';\nimport Album from '../types/Album';\nimport Artist from '../types/Artist';\nimport { ImageFormat } from '../types/Image';\nimport Label, { LabelArtist } from '../types/Label';\nimport Track from '../types/Track';\nimport { fetchPage } from '../utils/Fetch';\nimport Limiter from '../utils/Limiter';\nimport { normalizeUrl } from '../utils/Parse';\nimport BandInfoParser from './BandInfoParser';\nimport DiscographyParser from './DiscographyParser';\nimport LabelArtistsParser from './LabelArtistsParser';\n\nexport interface BandAPIGetDiscographyParams {\n  bandUrl: string;\n  imageFormat?: string | number | ImageFormat;\n}\n\nexport interface BandAPIGetInfoParams {\n  bandUrl: string;\n  imageFormat?: string | number | ImageFormat;\n  labelId?: number;\n}\n\nexport interface BandAPIGetLabelArtistsParams {\n  labelUrl: string;\n  imageFormat?: string | number | ImageFormat;\n}\n\nexport default class BandAPI {\n\n  static async getDiscography(params: BandAPIGetDiscographyParams): Promise<Array<Album | Track>> {\n    const imageConstants = await ImageAPI.getConstants();\n    const opts = {\n      imageBaseUrl: imageConstants.baseUrl,\n      bandUrl: params.bandUrl,\n      imageFormat: await ImageAPI.getFormat(params.imageFormat, 9)\n    };\n    const html = await fetchPage(normalizeUrl('music', params.bandUrl));\n    return DiscographyParser.parseDiscography(html, opts);\n  }\n\n  static async getInfo(params: BandAPIGetInfoParams): Promise<Artist | Label> {\n    const opts = {\n      bandUrl: params.bandUrl,\n      imageFormat: await ImageAPI.getFormat(params.imageFormat, 21)\n    };\n\n    const url = this.getUrl(params.bandUrl);\n    const html = await fetchPage(url);\n    const result = BandInfoParser.parseInfo(html, opts);\n    // Return if result is complete\n    if (this.isInfoComplete(result)) {\n      return result;\n    }\n\n    // Info lacking name or label (for artist) - try getting them from music page\n    const musicUrl = this.getUrl(params.bandUrl, 'music');\n    const musicHtml = await fetchPage(musicUrl);\n    const info = BandInfoParser.parseInfo(musicHtml, opts);\n    this.fillInfo(result, info);\n    // Return if result is complete\n    if (this.isInfoComplete(result)) {\n      return result;\n    }\n\n    // Info is still lacking name or label (for artist) - last try with fetching\n    // From discog's first album or track\n    const discogItems = await this.getDiscography(params);\n    if (discogItems[0]) {\n      const url = discogItems[0]?.url;\n      if (url) {\n        const html = await fetchPage(url);\n        const info = BandInfoParser.parseInfo(html, opts);\n        this.fillInfo(result, info);\n      }\n    }\n\n    if (result.url === null) {\n      result.url = params.bandUrl;\n    }\n\n    return result;\n  }\n\n  static async getLabelArtists(params: BandAPIGetLabelArtistsParams): Promise<LabelArtist[]> {\n    const opts = {\n      labelUrl: params.labelUrl,\n      imageFormat: await ImageAPI.getFormat(params.imageFormat)\n    };\n\n    const html = await fetchPage(normalizeUrl('artists', params.labelUrl));\n    return LabelArtistsParser.parseLabelArtists(html, opts);\n  }\n\n  /**\n   * @internal\n   */\n  protected static getUrl(artistOrLabelUrl: string, path?: string, labelId?: string): string {\n    let url = path ? normalizeUrl(path, artistOrLabelUrl) : artistOrLabelUrl;\n    if (labelId) {\n      url += `/?label=${encodeURIComponent(labelId)}`;\n    }\n    return url;\n  }\n\n  /**\n   * @internal\n   */\n  protected static isInfoComplete(data: Artist | Label) {\n    return data.name && data.url &&\n      (data.type === 'label' || data.label);\n  }\n\n  /**\n   * @internal\n   */\n  protected static fillInfo<T extends Artist | Label>(target: T, src: T): T {\n    if (target.name === null) {\n      target.name = src.name;\n    }\n    if (target.url === null) {\n      target.url = src.url;\n    }\n    if (target.type === 'artist' && src.type === 'artist' && !target.label && src.label) {\n      target.label = src.label;\n    }\n\n    return target;\n  }\n}\n\nexport class LimiterBandAPI extends BandAPI {\n\n  static async getDiscography(params: BandAPIGetDiscographyParams): Promise<(Album | Track)[]> {\n    return Limiter.schedule(() => super.getDiscography(params));\n  }\n\n  static async getInfo(params: BandAPIGetInfoParams): Promise<Artist | Label> {\n    return Limiter.schedule(() => super.getInfo(params));\n  }\n\n  static async getLabelArtists(params: BandAPIGetLabelArtistsParams): Promise<LabelArtist[]> {\n    return Limiter.schedule(() => super.getLabelArtists(params));\n  }\n}\n"]}