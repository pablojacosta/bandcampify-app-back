{"version":3,"file":"TagAPI.js","sourceRoot":"","sources":["../../../../src/lib/tag/TagAPI.ts"],"names":[],"mappings":"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","sourcesContent":["import ImageAPI from '../image/ImageAPI';\nimport { ImageFormat } from '../types/Image';\nimport Tag, { AlbumHighlightsByTag, ReleasesByTag, TagList } from '../types/Tag';\nimport { URLS } from '../utils/Constants';\nimport { FetchMethod, fetchPage } from '../utils/Fetch';\nimport Limiter from '../utils/Limiter';\nimport { ParseError, normalizeUrl, splitUrl } from '../utils/Parse';\nimport AlbumHighlightsByTagParser from './AlbumHighlightsByTagParser';\nimport ReleasesByTagParser from './ReleasesByTagParser';\nimport TagInfoParser from './TagInfoParser';\nimport TagListParser from './TagListParser';\n\nexport interface TagAPIGetAlbumHighlightsParams {\n  tagUrl: string;\n  imageFormat?: string | number | ImageFormat;\n}\n\nexport interface TagAPIGetReleasesParams {\n  tagUrl: string;\n  imageFormat?: string | number | ImageFormat;\n  useHardcodedDefaultFilters?: boolean;\n  filters?: Record<string, string | number | Array<string | number>>;\n  page?: number;\n}\n\nexport default class TagAPI {\n\n  static async list(): Promise<TagList> {\n    const html = await fetchPage(normalizeUrl('tags'));\n    return TagListParser.parseTags(html);\n  }\n\n  static async getInfo(tagUrl: string): Promise<Tag> {\n    const html = await fetchPage(tagUrl);\n    return TagInfoParser.parseInfo(html, tagUrl);\n  }\n\n  static async getAlbumHighlights(params: TagAPIGetAlbumHighlightsParams): Promise<AlbumHighlightsByTag[]> {\n    const imageConstants = await ImageAPI.getConstants();\n    const opts = {\n      imageBaseUrl: imageConstants.baseUrl,\n      imageFormat: await ImageAPI.getFormat(params.imageFormat, 9)\n    };\n\n    const html = await fetchPage(params.tagUrl);\n    return AlbumHighlightsByTagParser.parseHighlights(html, opts);\n  }\n\n  static async getReleasesAvailableFilters(tagUrl: string): Promise<ReleasesByTag.Filter[]> {\n    const filterValueNames = await this.getReleaseFilterValueNames(tagUrl);\n    const html = await fetchPage(tagUrl);\n    return ReleasesByTagParser.parseFilters(html, filterValueNames);\n  }\n\n  static async getReleases(params: TagAPIGetReleasesParams): Promise<ReleasesByTag> {\n    const imageConstants = await ImageAPI.getConstants();\n    const opts = {\n      imageBaseUrl: imageConstants.baseUrl,\n      imageFormat: await ImageAPI.getFormat(params.imageFormat, 9)\n    };\n\n    const _getDefaultFilters = async (tagUrl: string) => {\n      if (params.useHardcodedDefaultFilters) {\n        let tagUrlPath = splitUrl(tagUrl).path;\n        if (tagUrlPath.endsWith('/')) {\n          tagUrlPath = tagUrlPath.substring(0, tagUrlPath.length - 1);\n        }\n        const tagValue = tagUrlPath.split('/').pop();\n\n        return Promise.resolve({\n          tags: [ tagValue ],\n          location: 0,\n          format: 'all',\n          sort: 'pop'\n        });\n      }\n\n      const filterOptions = await this.getReleasesAvailableFilters(tagUrl);\n      const defaultFilters: TagAPIGetReleasesParams['filters'] = {};\n      filterOptions.forEach((filter) => {\n        const selectedOption = filter.options.find((o) => o.selected);\n        const defaultOption = filter.options.find((o) => o.default);\n        if (selectedOption) {\n          if (filter.name === 'tags') {\n            defaultFilters[filter.name] = [ selectedOption.value ];\n          }\n          else {\n            defaultFilters[filter.name] = selectedOption.value;\n          }\n        }\n        else if (defaultOption) {\n          defaultFilters[filter.name] = defaultOption.value;\n        }\n      });\n\n      return defaultFilters;\n\n    };\n\n    const defaultFilters = await _getDefaultFilters(params.tagUrl);\n    const tagsFilter = Array.isArray(defaultFilters.tags) ? [ ...defaultFilters.tags ] : [];\n    if (params?.filters?.tags && Array.isArray(params.filters.tags)) {\n      params.filters.tags.forEach((tag) => {\n        if (!tagsFilter.includes(tag)) {\n          tagsFilter.push(tag);\n        }\n      });\n    }\n    const paramFilters = params.filters ? {\n      ...defaultFilters,\n      ...params.filters,\n      tags: tagsFilter\n    } : defaultFilters;\n\n    const postData = {\n      filters: paramFilters,\n      page: params.page || 1\n    };\n\n    const json = await fetchPage(URLS.DIG_DEEPER, true, FetchMethod.POST, postData);\n    return ReleasesByTagParser.parseReleases(json, opts);\n  }\n\n  /**\n   * @internal\n   */\n  protected static async getReleaseFilterValueNames(tagUrl: string) {\n    const url = `${tagUrl}?tab=all_releases`;\n    const html = await fetchPage(url);\n    const path = ReleasesByTagParser.parseHubJSPath(html);\n    if (!path) {\n      throw new ParseError(`Failed to obtain Hub JS path from ${url}`, html);\n    }\n    const js = await fetchPage(path);\n    try {\n      return ReleasesByTagParser.parseHubJSFilterValueNames(js);\n    }\n    catch (error: any) {\n      throw new ParseError('Failed to obtain filter names / values from Hub JS', js, error);\n    }\n  }\n}\n\nexport class LimiterTagAPI extends TagAPI {\n\n  static async list(): Promise<TagList> {\n    return Limiter.schedule(() => super.list());\n  }\n\n  static async getInfo(tagUrl: string): Promise<Tag> {\n    return Limiter.schedule(() => super.getInfo(tagUrl));\n  }\n\n  static async getAlbumHighlights(params: TagAPIGetAlbumHighlightsParams): Promise<AlbumHighlightsByTag[]> {\n    return Limiter.schedule(() => super.getAlbumHighlights(params));\n  }\n\n  static async getReleasesAvailableFilters(tagUrl: string): Promise<ReleasesByTag.Filter[]> {\n    return Limiter.schedule(() => super.getReleasesAvailableFilters(tagUrl));\n  }\n\n  static async getReleases(params: TagAPIGetReleasesParams): Promise<ReleasesByTag> {\n    return Limiter.schedule(() => super.getReleases(params));\n  }\n}\n"]}