{"version":3,"file":"DiscoveryAPI.js","sourceRoot":"","sources":["../../../../src/lib/discovery/DiscoveryAPI.ts"],"names":[],"mappings":"AAAA,OAAO,QAAQ,MAAM,mBAAmB,CAAC;AAEzC,OAAO,EAAE,KAAK,EAAE,aAAa,EAAE,MAAM,gBAAgB,CAAC;AACtD,OAAO,EAAE,IAAI,EAAE,MAAM,oBAAoB,CAAC;AAC1C,OAAO,EAAE,WAAW,EAAE,SAAS,EAAE,MAAM,gBAAgB,CAAC;AACxD,OAAO,OAAO,MAAM,kBAAkB,CAAC;AAEvC,OAAO,qBAAqB,MAAM,yBAAyB,CAAC;AAC5D,OAAO,oBAAoB,MAAM,wBAAwB,CAAC;AAa1D,MAAM,CAAC,OAAO,OAAO,YAAY;IAE/B,MAAM,CAAC,KAAK,CAAC,mBAAmB;QAC9B,OAAO,KAAK,CAAC,QAAQ,CAAC,aAAa,CAAC,SAAS,EAAE,iBAAiB,EAAE,KAAK,IAAI,EAAE;YAC3E,MAAM,IAAI,GAAG,MAAM,SAAS,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;YAC5C,OAAO,qBAAqB,CAAC,YAAY,CAAC,IAAI,CAAC,CAAC;QAClD,CAAC,CAAC,CAAC;IACL,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,sBAAsB,CAAC,MAAuB;QACzD,MAAM,OAAO,GAAG,MAAM,IAAI,CAAC,mBAAmB,EAAE,CAAC;QAEjD,MAAM,eAAe,GAAG,CAAI,MAA0B,EAAE,KAAS,EAAE,YAAY,GAAG,CAAC,EAAE,EAAE;YACrF,IAAI,KAAK,KAAK,SAAS,IAAI,MAAM,EAAE;gBACjC,MAAM,GAAG,GAAG,MAAM,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,KAAK,IAAI,KAAK,CAAC,CAAC;gBACjD,IAAI,GAAG,EAAE;oBACP,OAAO,GAAG,CAAC,KAAK,CAAC;iBAClB;aACF;YACD,IAAI,MAAM,EAAE;gBACV,OAAO,MAAM,CAAC,YAAY,CAAC,CAAC,KAAK,CAAC;aACnC;YAED,OAAO,SAAS,CAAC;QAEnB,CAAC,CAAC;QAEF,MAAM,SAAS,GAAmB;YAChC,KAAK,EAAE,eAAe,CAAC,OAAO,CAAC,MAAM,EAAE,MAAM,EAAE,KAAK,CAAC;YACrD,MAAM,EAAE,eAAe,CAAC,OAAO,CAAC,OAAO,EAAE,MAAM,EAAE,MAAM,CAAC;YACxD,IAAI,EAAE,MAAM,EAAE,IAAI,IAAI,CAAC;SACxB,CAAC;QAEF,IAAI,SAAS,CAAC,MAAM,KAAK,KAAK,IAAI,SAAS,CAAC,KAAK,EAAE;YACjD,uEAAuE;YACvE,MAAM,eAAe,GAAG,OAAO,CAAC,SAAS,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YAC3D,IAAI,eAAe,EAAE,EAAE,4BAA4B;gBACjD,SAAS,CAAC,QAAQ,GAAG,eAAe,CAAC,eAAe,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC;aACzE;YACD,sHAAsH;YACtH,MAAM,WAAW,GAAG,SAAS,CAAC,QAAQ,KAAK,SAAS,IAAI,SAAS,CAAC,QAAQ,IAAI,eAAe,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;YACvG,IAAI,WAAW,EAAE;gBACf,SAAS,CAAC,IAAI,GAAG,eAAe,CAAC,OAAO,CAAC,KAAK,EAAE,MAAM,EAAE,IAAI,EAAE,CAAC,CAAC,CAAC;aAClE;YACD,SAAS,CAAC,QAAQ,GAAG,eAAe,CAAC,OAAO,CAAC,SAAS,EAAE,MAAM,EAAE,QAAQ,CAAC,CAAC;YAC1E,SAAS,CAAC,MAAM,GAAG,eAAe,CAAC,OAAO,CAAC,OAAO,EAAE,MAAM,EAAE,MAAM,CAAC,CAAC;SACrE;aACI;YACH,SAAS,CAAC,wBAAwB,GAAG,eAAe,CAAC,OAAO,CAAC,yBAAyB,EAAE,MAAM,EAAE,wBAAwB,CAAC,CAAC;SAC3H;QAED,OAAO,SAAS,CAAC;IACnB,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,MAAuB;QAC3C,MAAM,cAAc,GAAG,MAAM,QAAQ,CAAC,YAAY,EAAE,CAAC;QACrD,MAAM,IAAI,GAAG;YACX,YAAY,EAAE,cAAc,CAAC,OAAO;YACpC,gBAAgB,EAAE,MAAM,QAAQ,CAAC,SAAS,CAAC,MAAM,EAAE,gBAAgB,EAAE,CAAC,CAAC;YACvE,iBAAiB,EAAE,MAAM,QAAQ,CAAC,SAAS,CAAC,MAAM,EAAE,iBAAiB,EAAE,EAAE,CAAC;SAC3E,CAAC;QAEF,MAAM,eAAe,GAAG,MAAM,IAAI,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC;QAClE,MAAM,YAAY,GAAG,EAAE,GAAG,eAAe,EAAE,CAAC;QAC5C,wEAAwE;QACxE,0DAA0D;QAC1D,iFAAiF;QACjF,IAAI,eAAe,CAAC,IAAI,KAAK,SAAS,EAAE;YACtC,4EAA4E;YAC5E,sCAAsC;YACtC,OAAO,eAAe,CAAC,QAAQ,CAAC;SACjC;QAED,MAAM,OAAO,GAAG,IAAI,CAAC,yBAAyB,CAAC,eAAe,CAAC,CAAC;QAChE,MAAM,IAAI,GAAG,MAAM,SAAS,CAAC,IAAI,CAAC,YAAY,EAAE,IAAI,EAAE,WAAW,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;QAChF,OAAO,oBAAoB,CAAC,mBAAmB,CAAC,IAAI,EAAE,IAAI,EAAE,YAAY,CAAC,CAAC;IAC5E,CAAC;IAED;;OAEG;IACO,MAAM,CAAC,yBAAyB,CAAC,MAAsB;QAC/D,MAAM,MAAM,GAA2B;YACrC,CAAC,EAAE,MAAM,CAAC,MAAM,IAAI,KAAK;YACzB,CAAC,EAAE,MAAM,CAAC,IAAI,IAAI,CAAC;SACpB,CAAC;QACF,IAAI,MAAM,CAAC,KAAK,EAAE;YAChB,MAAM,CAAC,CAAC,GAAG,MAAM,CAAC,KAAK,CAAC;YAExB,IAAI,MAAM,CAAC,QAAQ,EAAE;gBACnB,MAAM,CAAC,CAAC,GAAG,MAAM,CAAC,QAAQ,CAAC;aAC5B;SACF;QACD,IAAI,MAAM,CAAC,QAAQ,KAAK,SAAS,EAAE;YACjC,MAAM,CAAC,EAAE,GAAG,MAAM,CAAC,QAAQ,CAAC;SAC7B;QACD,IAAI,MAAM,CAAC,MAAM,EAAE;YACjB,MAAM,CAAC,CAAC,GAAG,MAAM,CAAC,MAAM,CAAC;SAC1B;QACD,IAAI,MAAM,CAAC,CAAC,KAAK,KAAK,IAAI,MAAM,CAAC,wBAAwB,EAAE;YACzD,MAAM,CAAC,CAAC,GAAG,MAAM,CAAC,wBAAwB,CAAC;SAC5C;QACD,IAAI,MAAM,CAAC,IAAI,KAAK,SAAS,EAAE;YAC7B,MAAM,CAAC,CAAC,GAAG,MAAM,CAAC,IAAI,CAAC;SACxB;QAED,OAAO,MAAM,CAAC;IAChB,CAAC;CACF;AAED,MAAM,OAAO,mBAAoB,SAAQ,YAAY;IAEnD,MAAM,CAAC,KAAK,CAAC,mBAAmB;QAC9B,OAAO,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,mBAAmB,EAAE,CAAC,CAAC;IAC7D,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,sBAAsB,CAAC,MAAsB;QACxD,OAAO,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,sBAAsB,CAAC,MAAM,CAAC,CAAC,CAAC;IACtE,CAAC;IAED,MAAM,CAAC,KAAK,CAAC,QAAQ,CAAC,MAAsB;QAC1C,OAAO,OAAO,CAAC,QAAQ,CAAC,GAAG,EAAE,CAAC,KAAK,CAAC,QAAQ,CAAC,MAAM,CAAC,CAAC,CAAC;IACxD,CAAC;CACF","sourcesContent":["import ImageAPI from '../image/ImageAPI';\nimport { DiscoverOptions, DiscoverParams, DiscoverResult } from '../types/Discovery';\nimport { Cache, CacheDataType } from '../utils/Cache';\nimport { URLS } from '../utils/Constants';\nimport { FetchMethod, fetchPage } from '../utils/Fetch';\nimport Limiter from '../utils/Limiter';\nimport NameValuePair from '../utils/NameValuePair';\nimport DiscoverOptionsParser from './DiscoverOptionsParser';\nimport DiscoverResultParser from './DiscoverResultParser';\n\ninterface DiscoverRequestPayload {\n  s: string; // SortyBy\n  p: number; // Page\n  g?: string; // Genre\n  t?: string; // Subgenre\n  gn?: string; // Location\n  f?: string; // Format\n  r?: string; // Artist recommedation type\n  w?: number; // Time\n}\n\nexport default class DiscoveryAPI {\n\n  static async getAvailableOptions(): Promise<DiscoverOptions> {\n    return Cache.getOrSet(CacheDataType.Constants, 'discoverOptions', async () => {\n      const html = await fetchPage(URLS.SITE_URL);\n      return DiscoverOptionsParser.parseOptions(html);\n    });\n  }\n\n  static async sanitizeDiscoverParams(params?: DiscoverParams): Promise<DiscoverParams> {\n    const options = await this.getAvailableOptions();\n\n    const _getOptionValue = <T>(optArr: NameValuePair<T>[], value?: T, defaultIndex = 0) => {\n      if (value !== undefined && optArr) {\n        const opt = optArr.find((o) => o.value == value);\n        if (opt) {\n          return opt.value;\n        }\n      }\n      if (optArr) {\n        return optArr[defaultIndex].value;\n      }\n\n      return undefined;\n\n    };\n\n    const sanitized: DiscoverParams = {\n      genre: _getOptionValue(options.genres, params?.genre),\n      sortBy: _getOptionValue(options.sortBys, params?.sortBy),\n      page: params?.page || 0\n    };\n\n    if (sanitized.sortBy !== 'rec' && sanitized.genre) {\n      // Following only available when sortBy is not 'rec' (artist-recommend)\n      const subgenreOptions = options.subgenres[sanitized.genre];\n      if (subgenreOptions) { // `false` if genre is 'all'\n        sanitized.subgenre = _getOptionValue(subgenreOptions, params?.subgenre);\n      }\n      // 'Time' option only available when there is effectively no subgenre (e.g. genre is 'all' or subgenre is 'all-metal')\n      const timeAllowed = sanitized.subgenre === undefined || sanitized.subgenre == subgenreOptions[0].value;\n      if (timeAllowed) {\n        sanitized.time = _getOptionValue(options.times, params?.time, 1);\n      }\n      sanitized.location = _getOptionValue(options.locations, params?.location);\n      sanitized.format = _getOptionValue(options.formats, params?.format);\n    }\n    else {\n      sanitized.artistRecommendationType = _getOptionValue(options.artistRecommendationTypes, params?.artistRecommendationType);\n    }\n\n    return sanitized;\n  }\n\n  static async discover(params?: DiscoverParams): Promise<DiscoverResult> {\n    const imageConstants = await ImageAPI.getConstants();\n    const opts = {\n      imageBaseUrl: imageConstants.baseUrl,\n      albumImageFormat: await ImageAPI.getFormat(params?.albumImageFormat, 9),\n      artistImageFormat: await ImageAPI.getFormat(params?.artistImageFormat, 21)\n    };\n\n    const sanitizedParams = await this.sanitizeDiscoverParams(params);\n    const resultParams = { ...sanitizedParams };\n    // Passing an 'all' type subgenre (e.g. 'all-metal') in the discover url\n    // Actually returns far fewer / zero results than without.\n    // The Bandcamp site also does not seem to include it in its discover requests...\n    if (sanitizedParams.time !== undefined) {\n      // If 'time' exists in sanitized params, then we have an 'all' type subgenre\n      // - refer to sanitizeDiscoverParams()\n      delete sanitizedParams.subgenre;\n    }\n\n    const payload = this.getDiscoverRequestPayload(sanitizedParams);\n    const json = await fetchPage(URLS.DISCOVER_URL, true, FetchMethod.GET, payload);\n    return DiscoverResultParser.parseDiscoverResult(json, opts, resultParams);\n  }\n\n  /**\n   * @internal\n   */\n  protected static getDiscoverRequestPayload(params: DiscoverParams): DiscoverRequestPayload {\n    const result: DiscoverRequestPayload = {\n      s: params.sortBy || 'top',\n      p: params.page || 0\n    };\n    if (params.genre) {\n      result.g = params.genre;\n\n      if (params.subgenre) {\n        result.t = params.subgenre;\n      }\n    }\n    if (params.location !== undefined) {\n      result.gn = params.location;\n    }\n    if (params.format) {\n      result.f = params.format;\n    }\n    if (result.s === 'rec' && params.artistRecommendationType) {\n      result.r = params.artistRecommendationType;\n    }\n    if (params.time !== undefined) {\n      result.w = params.time;\n    }\n\n    return result;\n  }\n}\n\nexport class LimiterDiscoveryAPI extends DiscoveryAPI {\n\n  static async getAvailableOptions(): Promise<DiscoverOptions> {\n    return Limiter.schedule(() => super.getAvailableOptions());\n  }\n\n  static async sanitizeDiscoverParams(params: DiscoverParams): Promise<DiscoverParams> {\n    return Limiter.schedule(() => super.sanitizeDiscoverParams(params));\n  }\n\n  static async discover(params: DiscoverParams): Promise<DiscoverResult> {\n    return Limiter.schedule(() => super.discover(params));\n  }\n}\n"]}